blueprint:
  name: Ikea up/down button (E1766) cover control
  description: Control cover with IKEA Tradfri Open/Close Remote (E1766). Short presses fully open or close the cover, long presses open/close while held and stop upon release.
  domain: automation
  input:
    button:
      name: button
      description: Ikea Button (E1766)
      selector:
        device:
          multiple: false
          filter:
            - integration: mqtt
              manufacturer: IKEA
    cover:
      name: Cover
      description: Controlled Cover
      selector:
        target:
          entity:
            - domain:
                - cover
mode: restart
max_exceeded: silent
trigger:
  - id: button_close
    domain: mqtt
    device_id: !input button
    type: action
    subtype: "close"
    trigger: device
  - id: button_open
    domain: mqtt
    device_id: !input button
    type: action
    subtype: "open"
    trigger: device
  - id: button_stop
    domain: mqtt
    device_id: !input button
    type: action
    subtype: "stop"
    trigger: device
variables:
  command: "{{ trigger.id }}"
  cover_entity_id: "{{ cover.entity_id[0] }}"
  is_moving: "{{ states(cover_entity_id) in ['opening', 'closing'] }}"
action:
  - choose:
      - conditions:
          - "{{ command == 'button_close' }}"
          - condition: template
            value_template: "{{ not is_moving }}"
        sequence:
          - service: cover.close_cover
            target: !input cover
            data: {}
      - conditions:
          - "{{ command == 'button_close' }}"
        sequence:
          - service: cover.stop_cover
            target: !input cover
            data: {}
      - conditions:
          - "{{ command == 'button_open' }}"
          - condition: template
            value_template: "{{ not is_moving }}"
        sequence:
          - service: cover.open_cover
            data: {}
            target: !input cover
      - conditions:
          - "{{ command == 'button_open' }}"
        sequence:
          - service: cover.stop_cover
            target: !input cover
            data: {}
      - conditions:
          - "{{ command == 'button_stop' }}"
        sequence:
          - service: cover.stop_cover
            data: {}
            target: !input cover
